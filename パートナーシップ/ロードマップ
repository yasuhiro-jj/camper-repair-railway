# ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

æ—¢å­˜ã®ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã«ã€ä¿®ç†åº—ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ä¿®ç†åº—ç´¹ä»‹ãƒ»å•†è«‡ç®¡ç†ï¼‰ã‚’çµ±åˆã™ã‚‹ãŸã‚ã®å®Ÿè£…è¨ˆç”»ã§ã™ã€‚

---

## ğŸ“‹ å‰ææ¡ä»¶

### æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Flask + Python 3.10+ (`unified_backend_api.py`)
- **AI**: LangChain + OpenAI GPT-4 + LangGraph
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Notion + ChromaDB
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: HTML + CSS + JavaScript (Vanilla) (`templates/unified_chatbot.html`)
- **ãƒ‡ãƒ—ãƒ­ã‚¤**: Railway
- **ãƒ¡ã‚¤ãƒ³UI**: `templates/unified_chatbot.html`
- **ãƒ¡ã‚¤ãƒ³API**: `unified_backend_api.py` (`/api/unified/chat`)

### çµ±åˆã™ã‚‹æ©Ÿèƒ½ï¼ˆå¯¾è±¡ç¯„å›²ï¼‰
```
ã€ã‚¹ãƒ†ãƒƒãƒ—6ã€‘å•ã„åˆã‚ã›ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
â”œâ”€ ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆä¸Šã§å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
â”‚  â”œâ”€ åå‰
â”‚  â”œâ”€ é›»è©±ç•ªå·
â”‚  â””â”€ ç—‡çŠ¶è©³ç´°ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰
â”œâ”€ é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
â””â”€ ã‚·ã‚¹ãƒ†ãƒ ãŒä»¥ä¸‹ã‚’å®Ÿè¡Œ
    â”œâ”€ Notionã®å•†è«‡ç®¡ç†DBã«è¨˜éŒ²
    â”œâ”€ ä¿®ç†åº—ã«é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ« or LINEï¼‰
    â””â”€ é¡§å®¢ã«ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

---

## ğŸ—ºï¸ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ï¼ˆå…¨ä½“ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»æº–å‚™ï¼ˆ1-2æ—¥ï¼‰
- Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®šç¾©

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIé–‹ç™ºï¼ˆ3-5æ—¥ï¼‰
- Flask APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆï¼ˆ`unified_backend_api.py`ã«è¿½åŠ ï¼‰
- Notionçµ±åˆå‡¦ç†ï¼ˆæ—¢å­˜ã®`data_access/notion_client.py`ã‚’æ‹¡å¼µï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºï¼ˆ2-3æ—¥ï¼‰
- å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ UIï¼ˆ`templates/unified_chatbot.html`ã«è¿½åŠ ï¼‰
- ä¿®ç†åº—ç´¹ä»‹ã‚«ãƒ¼ãƒ‰

### ãƒ•ã‚§ãƒ¼ã‚º4: é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºï¼ˆ2-3æ—¥ï¼‰
- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥æ©Ÿèƒ½
- LINEé€šçŸ¥æ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º5: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ1-2æ—¥ï¼‰
- çµ±åˆãƒ†ã‚¹ãƒˆ
- Railwayæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

**ç·é–‹ç™ºæœŸé–“: ç´„2é€±é–“ï¼ˆ9-15æ—¥ï¼‰**

---

## ğŸ“Š ãƒ•ã‚§ãƒ¼ã‚º1: Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»æº–å‚™

### 1.1 å¿…è¦ãªNotionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

#### âœ… ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—ãƒã‚¹ã‚¿DB
```
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å: ã€Œãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—ã€

ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ§‹æˆã€‘
1. åº—èˆ—ID (Title) - è‡ªå‹•æ¡ç•ªï¼ˆä¾‹: SHOP-001ï¼‰
2. åº—èˆ—å (Text) - ä¾‹: å±±ç”°ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†
3. é›»è©±ç•ªå· (Phone) - ä¾‹: 086-123-4567
4. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (Email) - é€šçŸ¥å…ˆ
5. æ‰€åœ¨åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰ (Select) - å²¡å±±çœŒã€åºƒå³¶çœŒ...
6. ä½æ‰€ (Text) - è©³ç´°ä½æ‰€
7. å°‚é–€åˆ†é‡ (Multi-select) - ã‚¨ã‚¢ã‚³ãƒ³ã€é›»è£…ç³»ã€ã‚µãƒ–ãƒãƒƒãƒ†ãƒªãƒ¼ã€æ°´å›ã‚Š...
8. å–¶æ¥­æ™‚é–“ (Text) - ä¾‹: 9:00-18:00
9. åˆè¨ºæ–­æ–™ (Number) - ä¾‹: 3000å††
10. æˆç´„ç‡ (Number) - ä¾‹: 85.5%
11. ç·ç´¹ä»‹æ•° (Number) - ç´¯è¨ˆç´¹ä»‹ä»¶æ•°
12. æˆç´„æ•° (Number) - ç´¯è¨ˆæˆç´„ä»¶æ•°
13. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Select) - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã€ä¼‘æ­¢ä¸­ã€é€€ä¼š
14. LINEé€šçŸ¥ (Checkbox) - LINEé€šçŸ¥ã®æœ‰ç„¡
15. LINE Webhook URL (URL) - LINEé€šçŸ¥å…ˆ
16. ç™»éŒ²æ—¥ (Date) - ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç™»éŒ²æ—¥
17. å‚™è€ƒ (Text) - ãƒ¡ãƒ¢
```

#### âœ… å•†è«‡ç®¡ç†DBï¼ˆæ–°è¦ä½œæˆï¼‰
```
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å: ã€Œå•†è«‡ç®¡ç†ã€

ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ§‹æˆã€‘
1. å•†è«‡ID (Title) - è‡ªå‹•æ¡ç•ªï¼ˆä¾‹: DEAL-20241103-001ï¼‰
2. é¡§å®¢å (Text)
3. é›»è©±ç•ªå· (Phone)
4. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ (Email) - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
5. æ‰€åœ¨åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰ (Select)
6. ç—‡çŠ¶ã‚«ãƒ†ã‚´ãƒª (Select) - ã‚¨ã‚¢ã‚³ãƒ³ã€ãƒãƒƒãƒ†ãƒªãƒ¼ã€é›»è£…ç³»...
7. ç—‡çŠ¶è©³ç´° (Text) - ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‹ã‚‰è‡ªå‹•å…¥åŠ›
8. ç´¹ä»‹ä¿®ç†åº— (Relation) - ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—DBã¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
9. å•ã„åˆã‚ã›æ—¥æ™‚ (Date)
10. ç´¹ä»‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Select)
    - pending: å•ã„åˆã‚ã›ä¸­
    - contacted: ä¿®ç†åº—ã‹ã‚‰é€£çµ¡æ¸ˆã¿
    - completed: æˆç´„æ¸ˆã¿
    - cancelled: ã‚­ãƒ£ãƒ³ã‚»ãƒ«
11. æˆç´„æ—¥ (Date)
12. æˆç´„é‡‘é¡ (Number)
13. æ‰‹æ•°æ–™ç‡ (Number) - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ15%
14. æ‰‹æ•°æ–™é‡‘é¡ (Formula) - æˆç´„é‡‘é¡ Ã— æ‰‹æ•°æ–™ç‡
15. æ”¯æ‰•ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (Select) - æœªæ‰•ã„ã€æ”¯æ‰•æ¸ˆã¿
16. å‚™è€ƒ (Text)
```

#### âœ… ç—‡çŠ¶ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿DBï¼ˆæ—¢å­˜æ‹¡å¼µ or æ–°è¦ä½œæˆï¼‰
```
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å: ã€Œç—‡çŠ¶ã‚«ãƒ†ã‚´ãƒªã€ï¼ˆæ—¢å­˜ã®ä¿®ç†ã‚±ãƒ¼ã‚¹DBã®ã‚«ãƒ†ã‚´ãƒªã‚’ä½¿ç”¨å¯èƒ½ï¼‰

ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ§‹æˆã€‘
1. ã‚«ãƒ†ã‚´ãƒªå (Title) - ã‚¨ã‚¢ã‚³ãƒ³ã€ãƒãƒƒãƒ†ãƒªãƒ¼ã€é›»è£…ç³»...
2. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (Multi-select) - æ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
3. å°‚é–€åˆ†é‡ãƒãƒƒãƒ”ãƒ³ã‚° (Text) - ä¿®ç†åº—ã®å°‚é–€åˆ†é‡ã¨ä¸€è‡´ã•ã›ã‚‹
```

### 1.2 Notion APIã®æº–å‚™
```
å¿…è¦ãªä½œæ¥­:
1. Notion Integrationï¼ˆAPI Keyï¼‰ã®ç¢ºèªï¼ˆæ—¢å­˜ã®NOTION_API_KEYã‚’ä½¿ç”¨ï¼‰
2. ä¸Šè¨˜2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—ã€å•†è«‡ç®¡ç†ï¼‰ã‚’Integrationã«å…±æœ‰
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã®å–å¾—
4. .envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã‚’è¿½åŠ 
   - NOTION_PARTNER_DB_ID
   - NOTION_DEAL_DB_ID
```

### 1.3 ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
```
ã€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—ã€‘
- 3-5åº—èˆ—ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
- å²¡å±±çœŒå†…ã®æ¶ç©ºã®ä¿®ç†åº—

ã€å•†è«‡ç®¡ç†ã€‘
- ç©ºã§OKï¼ˆã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•ä½œæˆï¼‰
```

---

## ğŸ”§ ãƒ•ã‚§ãƒ¼ã‚º2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIé–‹ç™º

### 2.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
camper-repair-clean/
â”œâ”€â”€ unified_backend_api.py      # ã€æ—¢å­˜ãƒ»ä¿®æ­£ã€‘APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
â”œâ”€â”€ config.py                    # è¨­å®šç®¡ç†ï¼ˆæ—¢å­˜ï¼‰
â”œâ”€â”€ data_access/
â”‚   â”œâ”€â”€ notion_client.py         # ã€æ—¢å­˜ãƒ»æ‹¡å¼µã€‘Notionã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ partner_manager.py       # ã€æ–°è¦ã€‘ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç®¡ç†
â”‚   â””â”€â”€ deal_manager.py          # ã€æ–°è¦ã€‘å•†è«‡ç®¡ç†
â”œâ”€â”€ notification/
â”‚   â”œâ”€â”€ __init__.py              # ã€æ–°è¦ã€‘
â”‚   â”œâ”€â”€ email_sender.py          # ã€æ–°è¦ã€‘ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
â”‚   â””â”€â”€ line_notifier.py         # ã€æ–°è¦ã€‘LINEé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ unified_chatbot.html    # ã€æ—¢å­˜ãƒ»ä¿®æ­£ã€‘å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ è¿½åŠ 
â”‚   â””â”€â”€ repair_advice_center.html # ã€æ—¢å­˜ã€‘
â””â”€â”€ requirements.txt             # ä¾å­˜é–¢ä¿‚ï¼ˆæ—¢å­˜ãƒ»è¿½åŠ ä¸è¦ï¼‰
```

### 2.2 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: `data_access/partner_manager.py`
```python
"""
ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- ä¿®ç†åº—ã®æ¤œç´¢ãƒ»å–å¾—
- ç—‡çŠ¶ã‹ã‚‰æœ€é©ãªä¿®ç†åº—ã‚’é¸å®š
"""

import os
from typing import List, Dict, Optional
from data_access.notion_client import notion_client

class PartnerManager:
    def __init__(self):
        # æ—¢å­˜ã®notion_clientã‚’ä½¿ç”¨
        self.notion = notion_client.client
        self.partner_db_id = os.environ.get("NOTION_PARTNER_DB_ID")
        
        if not self.partner_db_id:
            raise ValueError("NOTION_PARTNER_DB_IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    
    def search_partners(
        self, 
        prefecture: str, 
        specialty: str, 
        limit: int = 3
    ) -> List[Dict]:
        """
        ç—‡çŠ¶ã¨æ‰€åœ¨åœ°ã‹ã‚‰æœ€é©ãªãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—ã‚’æ¤œç´¢
        
        Args:
            prefecture: éƒ½é“åºœçœŒï¼ˆä¾‹: å²¡å±±çœŒï¼‰
            specialty: å°‚é–€åˆ†é‡ï¼ˆä¾‹: ã‚¨ã‚¢ã‚³ãƒ³ï¼‰
            limit: å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ä»¶ï¼‰
        
        Returns:
            ä¿®ç†åº—ãƒªã‚¹ãƒˆï¼ˆæˆç´„ç‡é †ï¼‰
        """
        # Notion APIã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        query = {
            "database_id": self.partner_db_id,
            "filter": {
                "and": [
                    {
                        "property": "æ‰€åœ¨åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰",
                        "select": {"equals": prefecture}
                    },
                    {
                        "property": "å°‚é–€åˆ†é‡",
                        "multi_select": {"contains": specialty}
                    },
                    {
                        "property": "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
                        "select": {"equals": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–"}
                    }
                ]
            },
            "sorts": [
                {
                    "property": "æˆç´„ç‡",
                    "direction": "descending"
                }
            ],
            "page_size": limit
        }
        
        response = self.notion.databases.query(**query)
        
        # ãƒ‡ãƒ¼ã‚¿æ•´å½¢
        partners = []
        for page in response["results"]:
            props = page["properties"]
            partners.append({
                "shop_id": self._get_title(props.get("åº—èˆ—ID", {})),
                "name": self._get_text(props.get("åº—èˆ—å", {})),
                "phone": self._get_phone(props.get("é›»è©±ç•ªå·", {})),
                "email": self._get_email(props.get("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹", {})),
                "address": self._get_text(props.get("ä½æ‰€", {})),
                "business_hours": self._get_text(props.get("å–¶æ¥­æ™‚é–“", {})),
                "initial_fee": self._get_number(props.get("åˆè¨ºæ–­æ–™", {})),
                "success_rate": self._get_number(props.get("æˆç´„ç‡", {})),
                "line_webhook": self._get_url(props.get("LINE Webhook URL", {})),
                "page_id": page["id"]
            })
        
        return partners
    
    def _get_title(self, prop):
        """Notionã®ã‚¿ã‚¤ãƒˆãƒ«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—"""
        if not prop or "title" not in prop:
            return ""
        return prop["title"][0]["text"]["content"] if prop["title"] else ""
    
    def _get_text(self, prop):
        """Notionã®ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—"""
        if not prop or "rich_text" not in prop:
            return ""
        return prop["rich_text"][0]["text"]["content"] if prop["rich_text"] else ""
    
    def _get_phone(self, prop):
        """Notionã®é›»è©±ç•ªå·ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—"""
        if not prop:
            return ""
        return prop.get("phone_number", "")
    
    def _get_email(self, prop):
        """Notionã®ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—"""
        if not prop:
            return ""
        return prop.get("email", "")
    
    def _get_number(self, prop):
        """Notionã®æ•°å€¤ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—"""
        if not prop:
            return 0
        return prop.get("number", 0)
    
    def _get_url(self, prop):
        """Notionã®URLãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å€¤ã‚’å–å¾—"""
        if not prop:
            return ""
        return prop.get("url", "")
```

### 2.3 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: `data_access/deal_manager.py`
```python
"""
å•†è«‡ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- å•ã„åˆã‚ã›ã®è¨˜éŒ²
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
- æˆç´„å‡¦ç†
"""

import os
from datetime import datetime
from typing import Dict, Optional
from data_access.notion_client import notion_client

class DealManager:
    def __init__(self):
        # æ—¢å­˜ã®notion_clientã‚’ä½¿ç”¨
        self.notion = notion_client.client
        self.deal_db_id = os.environ.get("NOTION_DEAL_DB_ID")
        
        if not self.deal_db_id:
            raise ValueError("NOTION_DEAL_DB_IDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    
    def create_inquiry(
        self,
        customer_name: str,
        phone: str,
        prefecture: str,
        symptom_category: str,
        symptom_detail: str,
        partner_page_id: str,
        email: Optional[str] = None
    ) -> Dict:
        """
        æ–°è¦å•ã„åˆã‚ã›ã‚’å•†è«‡DBã«è¨˜éŒ²
        
        Args:
            customer_name: é¡§å®¢å
            phone: é›»è©±ç•ªå·
            prefecture: éƒ½é“åºœçœŒ
            symptom_category: ç—‡çŠ¶ã‚«ãƒ†ã‚´ãƒª
            symptom_detail: ç—‡çŠ¶è©³ç´°
            partner_page_id: ç´¹ä»‹ä¿®ç†åº—ã®Notion Page ID
            email: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        
        Returns:
            ä½œæˆã•ã‚ŒãŸå•†è«‡ãƒ‡ãƒ¼ã‚¿
        """
        # å•†è«‡IDã‚’ç”Ÿæˆï¼ˆä¾‹: DEAL-20241103-001ï¼‰
        deal_id = f"DEAL-{datetime.now().strftime('%Y%m%d-%H%M%S')}"
        
        # Notion APIã§ãƒšãƒ¼ã‚¸ä½œæˆ
        new_page = {
            "parent": {"database_id": self.deal_db_id},
            "properties": {
                "å•†è«‡ID": {
                    "title": [{"text": {"content": deal_id}}]
                },
                "é¡§å®¢å": {
                    "rich_text": [{"text": {"content": customer_name}}]
                },
                "é›»è©±ç•ªå·": {
                    "phone_number": phone
                },
                "æ‰€åœ¨åœ°ï¼ˆéƒ½é“åºœçœŒï¼‰": {
                    "select": {"name": prefecture}
                },
                "ç—‡çŠ¶ã‚«ãƒ†ã‚´ãƒª": {
                    "select": {"name": symptom_category}
                },
                "ç—‡çŠ¶è©³ç´°": {
                    "rich_text": [{"text": {"content": symptom_detail}}]
                },
                "ç´¹ä»‹ä¿®ç†åº—": {
                    "relation": [{"id": partner_page_id}]
                },
                "å•ã„åˆã‚ã›æ—¥æ™‚": {
                    "date": {"start": datetime.now().isoformat()}
                },
                "ç´¹ä»‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": {
                    "select": {"name": "pending"}
                },
                "æ‰‹æ•°æ–™ç‡": {
                    "number": 15
                }
            }
        }
        
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚Œã°è¿½åŠ 
        if email:
            new_page["properties"]["ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"] = {
                "email": email
            }
        
        response = self.notion.pages.create(**new_page)
        
        return {
            "deal_id": deal_id,
            "page_id": response["id"],
            "created_time": response["created_time"]
        }
    
    def update_status(self, page_id: str, status: str):
        """å•†è«‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°"""
        self.notion.pages.update(
            page_id=page_id,
            properties={
                "ç´¹ä»‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": {"select": {"name": status}}
            }
        )
    
    def record_completion(
        self, 
        page_id: str, 
        amount: float, 
        completion_date: Optional[str] = None
    ):
        """æˆç´„ã‚’è¨˜éŒ²"""
        if not completion_date:
            completion_date = datetime.now().isoformat()
        
        self.notion.pages.update(
            page_id=page_id,
            properties={
                "ç´¹ä»‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹": {"select": {"name": "completed"}},
                "æˆç´„æ—¥": {"date": {"start": completion_date}},
                "æˆç´„é‡‘é¡": {"number": amount}
            }
        )
```

### 2.4 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: `notification/email_sender.py`
```python
"""
ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- ä¿®ç†åº—ã¸ã®é€šçŸ¥
- é¡§å®¢ã¸ã®ç¢ºèªãƒ¡ãƒ¼ãƒ«
"""

import os
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from typing import Dict

class EmailSender:
    def __init__(self):
        self.smtp_host = os.environ.get("SMTP_HOST", "smtp.gmail.com")
        self.smtp_port = int(os.environ.get("SMTP_PORT", "587"))
        self.smtp_user = os.environ.get("SMTP_USER")
        self.smtp_password = os.environ.get("SMTP_PASSWORD")
        self.from_email = os.environ.get("FROM_EMAIL", self.smtp_user)
    
    def send_to_partner(
        self, 
        partner_email: str,
        partner_name: str,
        customer_info: Dict
    ):
        """
        ä¿®ç†åº—ã«å•ã„åˆã‚ã›é€šçŸ¥ã‚’é€ä¿¡
        
        Args:
            partner_email: ä¿®ç†åº—ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            partner_name: ä¿®ç†åº—å
            customer_info: é¡§å®¢æƒ…å ±ï¼ˆåå‰ã€é›»è©±ã€ç—‡çŠ¶ï¼‰
        """
        subject = "ã€æ–°è¦å•ã„åˆã‚ã›ã€‘å²¡å±±ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼"
        
        body = f"""
{partner_name} æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
å²¡å±±ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼ã§ã™ã€‚

æ–°ã—ã„å•ã„åˆã‚ã›ãŒå±Šãã¾ã—ãŸã€‚

ã€é¡§å®¢æƒ…å ±ã€‘
ãŠåå‰: {customer_info['name']}
é›»è©±ç•ªå·: {customer_info['phone']}
æ‰€åœ¨åœ°: {customer_info['prefecture']}

ã€ç—‡çŠ¶ã€‘
ã‚«ãƒ†ã‚´ãƒª: {customer_info['category']}
è©³ç´°:
{customer_info['detail']}

ãŠæ‰‹æ•°ã§ã™ãŒã€ãŠå®¢æ§˜ã¸ã®ã”é€£çµ¡ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

---
å²¡å±±ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼
https://web-production-c8b78.up.railway.app/
"""
        
        self._send_email(partner_email, subject, body)
    
    def send_to_customer(
        self,
        customer_email: str,
        customer_name: str,
        partner_name: str
    ):
        """
        é¡§å®¢ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
        
        Args:
            customer_email: é¡§å®¢ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            customer_name: é¡§å®¢å
            partner_name: ç´¹ä»‹ã—ãŸä¿®ç†åº—å
        """
        subject = "ã€å•ã„åˆã‚ã›å—ä»˜å®Œäº†ã€‘å²¡å±±ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼"
        
        body = f"""
{customer_name} æ§˜

ãŠå•ã„åˆã‚ã›ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
å²¡å±±ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼ã§ã™ã€‚

ä»¥ä¸‹ã®ä¿®ç†åº—ã«ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

ã€ç´¹ä»‹ä¿®ç†åº—ã€‘
{partner_name}

ä¿®ç†åº—ã‚ˆã‚Šç›´æ¥ã”é€£çµ¡ãŒã”ã–ã„ã¾ã™ã®ã§ã€
ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

---
å²¡å±±ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼
https://web-production-c8b78.up.railway.app/
"""
        
        if customer_email:
            self._send_email(customer_email, subject, body)
    
    def _send_email(self, to_email: str, subject: str, body: str):
        """ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®å®Ÿå‡¦ç†"""
        try:
            if not self.smtp_user or not self.smtp_password:
                print("âš ï¸ SMTPè¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
                return
            
            msg = MIMEMultipart()
            msg['From'] = self.from_email
            msg['To'] = to_email
            msg['Subject'] = subject
            
            msg.attach(MIMEText(body, 'plain', 'utf-8'))
            
            with smtplib.SMTP(self.smtp_host, self.smtp_port) as server:
                server.starttls()
                server.login(self.smtp_user, self.smtp_password)
                server.send_message(msg)
            
            print(f"âœ… ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ: {to_email}")
        except Exception as e:
            print(f"âŒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: {e}")
```

### 2.5 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«: `notification/line_notifier.py`
```python
"""
LINEé€šçŸ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- LINE Messaging APIã‚’ä½¿ã£ãŸé€šçŸ¥
"""

import os
import requests
from typing import Dict

class LineNotifier:
    def __init__(self):
        self.channel_access_token = os.environ.get("LINE_CHANNEL_ACCESS_TOKEN")
    
    def send_to_partner(
        self,
        webhook_url: str,
        customer_info: Dict
    ):
        """
        ä¿®ç†åº—ã«LINEé€šçŸ¥ã‚’é€ä¿¡
        
        Args:
            webhook_url: ä¿®ç†åº—ã®LINE Webhook URL
            customer_info: é¡§å®¢æƒ…å ±
        """
        if not webhook_url:
            return
        
        message = f"""
ã€æ–°è¦å•ã„åˆã‚ã›ã€‘

ãŠåå‰: {customer_info['name']}
é›»è©±: {customer_info['phone']}
ç—‡çŠ¶: {customer_info['category']}

è©³ç´°: {customer_info['detail']}
"""
        
        try:
            # LINE Messaging APIã§é€ä¿¡
            # ï¼ˆå®Ÿè£…ã¯ä¿®ç†åº—ã®LINEé€£æºæ–¹æ³•ã«ã‚ˆã‚‹ï¼‰
            print(f"âœ… LINEé€šçŸ¥é€ä¿¡: {webhook_url}")
        except Exception as e:
            print(f"âŒ LINEé€šçŸ¥å¤±æ•—: {e}")
```

### 2.6 `unified_backend_api.py`ã¸ã®è¿½åŠ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
```python
# unified_backend_api.py ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆéƒ¨åˆ†ã«è¿½åŠ 

from data_access.partner_manager import PartnerManager
from data_access.deal_manager import DealManager
from notification.email_sender import EmailSender
from notification.line_notifier import LineNotifier

# ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
partner_manager = None
deal_manager = None
email_sender = None
line_notifier = None

# initialize_services()é–¢æ•°å†…ã«è¿½åŠ 
def initialize_services():
    """ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–"""
    global db, category_manager, serp_system, notion_client_instance
    global partner_manager, deal_manager, email_sender, line_notifier
    
    # ... æ—¢å­˜ã®åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰ ...
    
    # ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ã®åˆæœŸåŒ–
    try:
        partner_manager = PartnerManager()
        deal_manager = DealManager()
        email_sender = EmailSender()
        line_notifier = LineNotifier()
        print("âœ… ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ")
    except Exception as e:
        print(f"âš ï¸ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ã®åˆæœŸåŒ–ã«å¤±æ•—: {e}")

# æ—¢å­˜ã®@app.route()ã®å¾Œã«è¿½åŠ 

@app.route('/api/partners/search', methods=['POST'])
def search_partners():
    """
    ç—‡çŠ¶ã‹ã‚‰æœ€é©ãªä¿®ç†åº—ã‚’æ¤œç´¢
    
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:
    {
        "prefecture": "å²¡å±±çœŒ",
        "symptom_category": "ã‚¨ã‚¢ã‚³ãƒ³"
    }
    
    ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
    {
        "partners": [
            {
                "shop_id": "SHOP-001",
                "name": "å±±ç”°ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†",
                "phone": "086-123-4567",
                "address": "å²¡å±±çœŒå²¡å±±å¸‚...",
                "business_hours": "9:00-18:00",
                "initial_fee": 3000,
                "success_rate": 85.5,
                "page_id": "notion-page-id"
            },
            ...
        ]
    }
    """
    try:
        if not partner_manager:
            return jsonify({"error": "ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"}), 503
        
        data = request.json
        prefecture = data.get('prefecture')
        symptom_category = data.get('symptom_category')
        
        if not prefecture or not symptom_category:
            return jsonify({"error": "å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"}), 400
        
        partners = partner_manager.search_partners(
            prefecture=prefecture,
            specialty=symptom_category,
            limit=3
        )
        
        return jsonify({"partners": partners})
    
    except Exception as e:
        print(f"âŒ ä¿®ç†åº—æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify({"error": str(e)}), 500


@app.route('/api/partners/submit-inquiry', methods=['POST'])
def submit_inquiry():
    """
    å•ã„åˆã‚ã›ã‚’é€ä¿¡
    
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:
    {
        "customer_name": "ç”°ä¸­å¤ªéƒ",
        "phone": "090-1234-5678",
        "email": "tanaka@example.com",  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        "prefecture": "å²¡å±±çœŒ",
        "symptom_category": "ã‚¨ã‚¢ã‚³ãƒ³",
        "symptom_detail": "ç•°éŸ³ãŒã—ã¦å†·ãˆãªã„",
        "partner_page_id": "notion-page-id-xxx",
        "partner_email": "shop@example.com",
        "partner_name": "å±±ç”°ã‚­ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã‚«ãƒ¼ä¿®ç†",
        "partner_line_webhook": "https://..."  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    }
    
    ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
    {
        "success": true,
        "deal_id": "DEAL-20241103-001",
        "message": "å•ã„åˆã‚ã›ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ"
    }
    """
    try:
        if not deal_manager:
            return jsonify({"error": "ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"}), 503
        
        data = request.json
        
        # å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
        required_fields = [
            'customer_name', 'phone', 'prefecture', 
            'symptom_category', 'symptom_detail', 'partner_page_id'
        ]
        for field in required_fields:
            if not data.get(field):
                return jsonify({"error": f"{field}ã¯å¿…é ˆã§ã™"}), 400
        
        # å•†è«‡DBã«è¨˜éŒ²
        deal_result = deal_manager.create_inquiry(
            customer_name=data['customer_name'],
            phone=data['phone'],
            prefecture=data['prefecture'],
            symptom_category=data['symptom_category'],
            symptom_detail=data['symptom_detail'],
            partner_page_id=data['partner_page_id'],
            email=data.get('email')
        )
        
        # ä¿®ç†åº—ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
        if data.get('partner_email') and email_sender:
            email_sender.send_to_partner(
                partner_email=data['partner_email'],
                partner_name=data.get('partner_name', 'ä¿®ç†åº—æ§˜'),
                customer_info={
                    'name': data['customer_name'],
                    'phone': data['phone'],
                    'prefecture': data['prefecture'],
                    'category': data['symptom_category'],
                    'detail': data['symptom_detail']
                }
            )
        
        # é¡§å®¢ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«
        if data.get('email') and email_sender:
            email_sender.send_to_customer(
                customer_email=data['email'],
                customer_name=data['customer_name'],
                partner_name=data.get('partner_name', 'ä¿®ç†åº—')
            )
        
        # LINEé€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if data.get('partner_line_webhook') and line_notifier:
            line_notifier.send_to_partner(
                webhook_url=data['partner_line_webhook'],
                customer_info={
                    'name': data['customer_name'],
                    'phone': data['phone'],
                    'category': data['symptom_category'],
                    'detail': data['symptom_detail']
                }
            )
        
        return jsonify({
            "success": True,
            "deal_id": deal_result['deal_id'],
            "message": "å•ã„åˆã‚ã›ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ä¿®ç†åº—ã‚ˆã‚Šé€£çµ¡ãŒã‚ã‚Šã¾ã™ã®ã§ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚"
        })
    
    except Exception as e:
        print(f"âŒ å•ã„åˆã‚ã›é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
        return jsonify({"error": str(e)}), 500
```

### 2.7 ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ ï¼ˆ`.env`ï¼‰
```bash
# æ—¢å­˜ã®ç’°å¢ƒå¤‰æ•°
OPENAI_API_KEY=sk-xxx
NOTION_API_KEY=secret_xxx
NOTION_LOG_DB_ID=xxx

# ã€è¿½åŠ ã€‘ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ç”¨
NOTION_PARTNER_DB_ID=your-partner-database-id
NOTION_DEAL_DB_ID=your-deal-database-id

# ã€è¿½åŠ ã€‘ãƒ¡ãƒ¼ãƒ«è¨­å®š
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
FROM_EMAIL=support@okayama-camper.com

# ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‘LINEè¨­å®š
LINE_CHANNEL_ACCESS_TOKEN=your-line-token
```

### 2.8 ä¾å­˜é–¢ä¿‚ã®è¿½åŠ ï¼ˆ`requirements.txt`ï¼‰
```
# æ—¢å­˜ã®ä¾å­˜é–¢ä¿‚
flask==2.3.0
flask-cors==4.0.0
...

# ã€è¿½åŠ ä¸è¦ã€‘ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯Pythonæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆsmtplibï¼‰ã‚’ä½¿ç”¨
# ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‘LINEé€šçŸ¥ç”¨
# line-bot-sdk==3.0.0
```

---

## ğŸ¨ ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º

### 3.1 ä¿®ç†åº—æ¤œç´¢ãƒ»è¡¨ç¤ºUIï¼ˆ`templates/unified_chatbot.html`ã«è¿½åŠ ï¼‰

```html
<!-- unified_chatbot.html ã® </body> ã‚¿ã‚°ã®å‰ã«è¿½åŠ  -->

<!-- ä¿®ç†åº—ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div id="partner-section" class="hidden" style="margin-top: 20px;">
    <div class="partner-container">
        <h3>ğŸ”§ ãŠè¿‘ãã®ä¿®ç†åº—ã‚’ã”ç´¹ä»‹ã—ã¾ã™</h3>
        <p>ç—‡çŠ¶ã«å¯¾å¿œã§ãã‚‹ä¿®ç†åº—ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™...</p>
        
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div id="partner-loading" class="loading">
            <div class="spinner"></div>
        </div>
        
        <!-- ä¿®ç†åº—ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
        <div id="partner-list"></div>
    </div>
</div>

<!-- å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="inquiry-modal" class="modal hidden">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>ğŸ“ ä¿®ç†åº—ã¸å•ã„åˆã‚ã›</h3>
        
        <form id="inquiry-form">
            <!-- é¸æŠã•ã‚ŒãŸä¿®ç†åº—æƒ…å ±ï¼ˆhiddenï¼‰ -->
            <input type="hidden" id="selected-partner-id" name="partner_page_id">
            <input type="hidden" id="selected-partner-name" name="partner_name">
            <input type="hidden" id="selected-partner-email" name="partner_email">
            <input type="hidden" id="selected-partner-line" name="partner_line_webhook">
            
            <!-- ç—‡çŠ¶æƒ…å ±ï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰ -->
            <input type="hidden" id="inquiry-prefecture" name="prefecture">
            <input type="hidden" id="inquiry-category" name="symptom_category">
            <input type="hidden" id="inquiry-detail" name="symptom_detail">
            
            <!-- é¡§å®¢å…¥åŠ›é …ç›® -->
            <div class="form-group">
                <label for="customer-name">ãŠåå‰ <span class="required">*</span></label>
                <input type="text" id="customer-name" name="customer_name" required placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ">
            </div>
            
            <div class="form-group">
                <label for="customer-phone">é›»è©±ç•ªå· <span class="required">*</span></label>
                <input type="tel" id="customer-phone" name="phone" required placeholder="ä¾‹: 090-1234-5678">
            </div>
            
            <div class="form-group">
                <label for="customer-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
                <input type="email" id="customer-email" name="email" placeholder="ä¾‹: tanaka@example.com">
            </div>
            
            <div class="form-group">
                <label>ç—‡çŠ¶è©³ç´°</label>
                <textarea id="inquiry-detail-display" readonly rows="4"></textarea>
            </div>
            
            <button type="submit" class="btn-submit">ã“ã®ä¿®ç†åº—ã«å•ã„åˆã‚ã›ã‚‹</button>
        </form>
    </div>
</div>

<style>
/* ä¿®ç†åº—ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.partner-container {
    margin-top: 20px;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 10px;
}

.partner-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.partner-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.partner-card h4 {
    margin: 0 0 10px 0;
    color: #333;
}

.partner-info {
    font-size: 14px;
    color: #666;
    margin: 5px 0;
}

.partner-badge {
    display: inline-block;
    background: #4CAF50;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-right: 5px;
}

.btn-inquiry {
    background: #FF9800;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
}

.btn-inquiry:hover {
    background: #F57C00;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.required {
    color: red;
}

.btn-submit {
    width: 100%;
    background: #4CAF50;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
}

.btn-submit:hover {
    background: #45a049;
}

.loading {
    text-align: center;
    padding: 20px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
```

### 3.2 JavaScriptå‡¦ç†ï¼ˆ`templates/unified_chatbot.html`å†…ã«è¿½åŠ ï¼‰

```javascript
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentSymptomData = {
    prefecture: '',
    category: '',
    detail: ''
};

// ä¿®ç†åº—æ¤œç´¢ã‚’è¡¨ç¤ºã™ã‚‹ãƒˆãƒªã‚¬ãƒ¼ï¼ˆãƒãƒ£ãƒƒãƒˆå†…ã§å‘¼ã³å‡ºã—ï¼‰
function showPartnerSearch(prefecture, category, detail) {
    // ç—‡çŠ¶ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    currentSymptomData = {
        prefecture: prefecture,
        category: category,
        detail: detail
    };
    
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
    document.getElementById('partner-section').classList.remove('hidden');
    document.getElementById('partner-loading').style.display = 'block';
    document.getElementById('partner-list').innerHTML = '';
    
    // ä¿®ç†åº—æ¤œç´¢APIå‘¼ã³å‡ºã—
    searchPartners(prefecture, category);
}

// ä¿®ç†åº—æ¤œç´¢API
async function searchPartners(prefecture, category) {
    try {
        const response = await fetch('/api/partners/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                prefecture: prefecture,
                symptom_category: category
            })
        });
        
        const data = await response.json();
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        document.getElementById('partner-loading').style.display = 'none';
        
        if (data.partners && data.partners.length > 0) {
            displayPartners(data.partners);
        } else {
            document.getElementById('partner-list').innerHTML = 
                '<p>ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ç¾åœ¨å¯¾å¿œå¯èƒ½ãªä¿®ç†åº—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        }
    } catch (error) {
        console.error('ä¿®ç†åº—æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('partner-loading').style.display = 'none';
        document.getElementById('partner-list').innerHTML = 
            '<p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>';
    }
}

// ä¿®ç†åº—ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
function displayPartners(partners) {
    const listElement = document.getElementById('partner-list');
    listElement.innerHTML = '';
    
    partners.forEach((partner, index) => {
        const card = document.createElement('div');
        card.className = 'partner-card';
        card.innerHTML = `
            <h4>${index + 1}. ${partner.name}</h4>
            <div class="partner-info">
                <span class="partner-badge">æˆç´„ç‡ ${partner.success_rate}%</span>
            </div>
            <div class="partner-info">
                ğŸ“ ${partner.address}
            </div>
            <div class="partner-info">
                ğŸ“ ${partner.phone}
            </div>
            <div class="partner-info">
                ğŸ• ${partner.business_hours}
            </div>
            <div class="partner-info">
                ğŸ’° åˆè¨ºæ–­æ–™: ${partner.initial_fee.toLocaleString()}å††
            </div>
            <button class="btn-inquiry" onclick="openInquiryModal('${partner.shop_id}', '${partner.name}', '${partner.email || ''}', '${partner.line_webhook || ''}', '${partner.page_id}')">
                ã“ã®ä¿®ç†åº—ã«å•ã„åˆã‚ã›ã‚‹
            </button>
        `;
        listElement.appendChild(card);
    });
}

// å•ã„åˆã‚ã›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openInquiryModal(shopId, name, email, lineWebhook, pageId) {
    // hiddené …ç›®ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('selected-partner-id').value = pageId;
    document.getElementById('selected-partner-name').value = name;
    document.getElementById('selected-partner-email').value = email;
    document.getElementById('selected-partner-line').value = lineWebhook;
    
    document.getElementById('inquiry-prefecture').value = currentSymptomData.prefecture;
    document.getElementById('inquiry-category').value = currentSymptomData.category;
    document.getElementById('inquiry-detail').value = currentSymptomData.detail;
    
    // ç—‡çŠ¶è©³ç´°ã‚’è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«åæ˜ 
    document.getElementById('inquiry-detail-display').value = currentSymptomData.detail;
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    document.getElementById('inquiry-modal').classList.remove('hidden');
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
document.querySelector('.close').onclick = function() {
    document.getElementById('inquiry-modal').classList.add('hidden');
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
window.onclick = function(event) {
    const modal = document.getElementById('inquiry-modal');
    if (event.target == modal) {
        modal.classList.add('hidden');
    }
};

// å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
document.getElementById('inquiry-form').onsubmit = async function(e) {
    e.preventDefault();
    
    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const submitBtn = e.target.querySelector('.btn-submit');
    submitBtn.disabled = true;
    submitBtn.textContent = 'é€ä¿¡ä¸­...';
    
    try {
        const response = await fetch('/api/partners/submit-inquiry', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`âœ… ${result.message}\n\nå•†è«‡ID: ${result.deal_id}`);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('inquiry-modal').classList.add('hidden');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            e.target.reset();
        } else {
            alert(`âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`);
        }
    } catch (error) {
        console.error('å•ã„åˆã‚ã›é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    } finally {
        // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        submitBtn.disabled = false;
        submitBtn.textContent = 'ã“ã®ä¿®ç†åº—ã«å•ã„åˆã‚ã›ã‚‹';
    }
};

// ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®AIå¿œç­”ã‹ã‚‰ä¿®ç†åº—æ¤œç´¢ã‚’ãƒˆãƒªã‚¬ãƒ¼
// æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã«çµ±åˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
// ä¾‹: AIãŒã€Œä¿®ç†åº—ã‚’ç´¹ä»‹ã—ã¾ã™ã‹ï¼Ÿã€ã¨èã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã¯ã„ã€ã‚’é¸æŠã—ãŸå ´åˆ
function triggerPartnerSearchFromChat() {
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‹ã‚‰ç—‡çŠ¶æƒ…å ±ã‚’æŠ½å‡º
    // ï¼ˆå®Ÿè£…ã¯æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã«ä¾å­˜ï¼‰
    
    // ä»®ã®ä¾‹
    const prefecture = 'å²¡å±±çœŒ';  // ãƒãƒ£ãƒƒãƒˆã‹ã‚‰æŠ½å‡º
    const category = 'ã‚¨ã‚¢ã‚³ãƒ³';   // ãƒãƒ£ãƒƒãƒˆã‹ã‚‰æŠ½å‡º
    const detail = 'ã‚¨ã‚¢ã‚³ãƒ³ã‹ã‚‰ç•°éŸ³ãŒã—ã¦å†·ãˆãªã„';  // ãƒãƒ£ãƒƒãƒˆã‹ã‚‰æŠ½å‡º
    
    showPartnerSearch(prefecture, category, detail);
}
</script>
```

### 3.3 ãƒãƒ£ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã¸ã®çµ±åˆ

æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆï¼ˆ`unified_backend_api.py`ã®`/api/unified/chat`ï¼‰ã«ã€ä»¥ä¸‹ã®å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```python
# unified_backend_api.py ã® unified_chat() é–¢æ•°å†…ã«è¿½åŠ 

# AIã®å¿œç­”ã«ã€Œä¿®ç†åº—ç´¹ä»‹ã€ã®ææ¡ˆã‚’å«ã‚ã‚‹
if "ä¿®ç†åº—" in user_message or "å°‚é–€æ¥­è€…" in user_message or "ç›¸è«‡" in user_message:
    # ç—‡çŠ¶æƒ…å ±ã‚’æŠ½å‡ºï¼ˆæ—¢å­˜ã®ã‚«ãƒ†ã‚´ãƒªãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨ï¼‰
    # ...
    
    # å¿œç­”ã«ä¿®ç†åº—æ¤œç´¢ãƒˆãƒªã‚¬ãƒ¼ã‚’å«ã‚ã‚‹
    response_data = {
        "message": "ãŠè¿‘ãã®ä¿®ç†åº—ã‚’ã”ç´¹ä»‹ã§ãã¾ã™ã€‚ä¿®ç†åº—ã‚’æ¤œç´¢ã—ã¾ã™ã‹ï¼Ÿ",
        "action": "show_partner_search",
        "data": {
            "prefecture": extracted_prefecture,
            "category": extracted_category,
            "detail": user_message
        }
    }
```

---

## ğŸ“§ ãƒ•ã‚§ãƒ¼ã‚º4: é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º

### 4.1 Gmail SMTPã®è¨­å®š

Gmailã‚’ä½¿ã£ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã™ã‚‹å ´åˆï¼š

```
1. Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã€Œ2æ®µéšèªè¨¼ã€ã‚’æœ‰åŠ¹åŒ–
2. ã€Œã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã‚’ç”Ÿæˆ
   https://myaccount.google.com/apppasswords
3. .envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®š
   SMTP_USER=your-email@gmail.com
   SMTP_PASSWORD=generated-app-password
```

### 4.2 ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡

```python
# test_email.pyï¼ˆãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰

from notification.email_sender import EmailSender

sender = EmailSender()

# ãƒ†ã‚¹ãƒˆé€ä¿¡
sender.send_to_partner(
    partner_email="test@example.com",
    partner_name="ãƒ†ã‚¹ãƒˆä¿®ç†åº—",
    customer_info={
        'name': 'ãƒ†ã‚¹ãƒˆé¡§å®¢',
        'phone': '090-0000-0000',
        'prefecture': 'å²¡å±±çœŒ',
        'category': 'ãƒãƒƒãƒ†ãƒªãƒ¼',
        'detail': 'ãƒãƒƒãƒ†ãƒªãƒ¼ãŒä¸ŠãŒã£ã¦ã‚¨ãƒ³ã‚¸ãƒ³ãŒã‹ã‹ã‚‰ãªã„'
    }
)

print("ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†")
```

### 4.3 LINEé€šçŸ¥ã®å®Ÿè£…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

LINE Messaging APIã‚’ä½¿ã†å ´åˆï¼š

```
1. LINE Developersã§ãƒãƒ£ãƒãƒ«ä½œæˆ
2. Channel Access Tokenã‚’å–å¾—
3. Webhook URLã‚’è¨­å®š
4. ä¿®ç†åº—ã”ã¨ã«LINEé€£æºè¨­å®š
```

---

## ğŸ§ª ãƒ•ã‚§ãƒ¼ã‚º5: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

### 5.1 ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ

```bash
# Anaconda Promptã§å®Ÿè¡Œ

# 1. ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
conda activate campingrepare

# 2. Flaskã‚µãƒ¼ãƒãƒ¼èµ·å‹•
python unified_backend_api.py

# 3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹
# http://localhost:5000/unified_chatbot.html
```

### 5.2 ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

#### âœ… ãƒ†ã‚¹ãƒˆ1: ä¿®ç†åº—æ¤œç´¢
```
1. ãƒãƒ£ãƒƒãƒˆã§ç—‡çŠ¶ã‚’å…¥åŠ›
2. ã€Œå°‚é–€æ¥­è€…ã«ç›¸è«‡ã—ãŸã„ã€ã‚’é¸æŠ
3. ä¿®ç†åº—ãŒ3ä»¶è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
4. å„ã‚«ãƒ¼ãƒ‰ã«æ­£ã—ã„æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

#### âœ… ãƒ†ã‚¹ãƒˆ2: å•ã„åˆã‚ã›é€ä¿¡
```
1. ä¿®ç†åº—ã‚«ãƒ¼ãƒ‰ã®ã€Œå•ã„åˆã‚ã›ãƒœã‚¿ãƒ³ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
3. åå‰ãƒ»é›»è©±ç•ªå·ã‚’å…¥åŠ›
4. é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ã€Œé€ä¿¡å®Œäº†ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
6. Notionå•†è«‡DBã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

#### âœ… ãƒ†ã‚¹ãƒˆ3: ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
```
1. å•ã„åˆã‚ã›é€ä¿¡å¾Œ
2. ä¿®ç†åº—ã«ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã“ã¨ã‚’ç¢ºèª
3. é¡§å®¢ã«ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã“ã¨ã‚’ç¢ºèªï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›æ™‚ï¼‰
```

### 5.3 Railwayãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# 1. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
# Railway ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ä»¥ä¸‹ã‚’è¿½åŠ :
# - NOTION_PARTNER_DB_ID
# - NOTION_DEAL_DB_ID
# - SMTP_HOST
# - SMTP_PORT
# - SMTP_USER
# - SMTP_PASSWORD
# - FROM_EMAIL

# 2. Gitã«ãƒ—ãƒƒã‚·ãƒ¥
git add .
git commit -m "Add partnership feature"
git push origin main

# 3. RailwayãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°ã‚’ç¢ºèª
```

### 5.4 æœ¬ç•ªå‹•ä½œç¢ºèª

```
1. ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹
   https://web-production-c8b78.up.railway.app/unified_chatbot.html
2. å…¨æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
3. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

## ğŸ“‹ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™
- [ ] Notionã€Œãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¿®ç†åº—ã€DBä½œæˆ
- [ ] Notionã€Œå•†è«‡ç®¡ç†ã€DBä½œæˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã‚’å–å¾—
- [ ] ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º
- [ ] `data_access/partner_manager.py`ä½œæˆ
- [ ] `data_access/deal_manager.py`ä½œæˆ
- [ ] `notification/email_sender.py`ä½œæˆ
- [ ] `notification/line_notifier.py`ä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- [ ] `unified_backend_api.py`ã«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆ`.env`ï¼‰

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º
- [ ] ä¿®ç†åº—æ¤œç´¢UIè¿½åŠ ï¼ˆ`templates/unified_chatbot.html`ï¼‰
- [ ] å•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ
- [ ] JavaScriptå‡¦ç†å®Ÿè£…
- [ ] ãƒãƒ£ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã¨ã®çµ±åˆ

### é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- [ ] Gmail SMTPè¨­å®š
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆ
- [ ] LINEé€šçŸ¥è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [ ] ä¿®ç†åº—æ¤œç´¢å‹•ä½œç¢ºèª
- [ ] å•ã„åˆã‚ã›é€ä¿¡å‹•ä½œç¢ºèª
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‹•ä½œç¢ºèª
- [ ] Notionè¨˜éŒ²å‹•ä½œç¢ºèª

### ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] Railwayç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] æœ¬ç•ªå‹•ä½œç¢ºèª

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå°†æ¥ã®æ‹¡å¼µï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º6: ä¿®ç†åº—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- ä¿®ç†åº—å°‚ç”¨ã®ç®¡ç†ç”»é¢
- å•ã„åˆã‚ã›ä¸€è¦§è¡¨ç¤º
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ©Ÿèƒ½
- æˆç´„å ±å‘Šæ©Ÿèƒ½

### ãƒ•ã‚§ãƒ¼ã‚º7: åç›Šåˆ†ææ©Ÿèƒ½
- æœˆæ¬¡åç›Šãƒ¬ãƒãƒ¼ãƒˆ
- ä¿®ç†åº—åˆ¥æˆç´„ç‡ã‚°ãƒ©ãƒ•
- é¡§å®¢æº€è¶³åº¦è¿½è·¡

### ãƒ•ã‚§ãƒ¼ã‚º8: è‡ªå‹•ãƒãƒƒãƒãƒ³ã‚°æ”¹å–„
- AIã«ã‚ˆã‚‹æœ€é©ãªä¿®ç†åº—é¸å®š
- é¡§å®¢è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ 
- ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆãƒ»è³ªå•

å®Ÿè£…ä¸­ã«ä¸æ˜ç‚¹ãŒã‚ã‚Œã°ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
1. Notion APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://developers.notion.com/
2. Flaskå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://flask.palletsprojects.com/
3. LangChainå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: https://python.langchain.com/

---

ã“ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã‚Œã°ã€ç´„2é€±é–“ã§ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—æ©Ÿèƒ½ã‚’æ—¢å­˜ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã«çµ±åˆã§ãã¾ã™ï¼ğŸ‰
```

ä¸»ãªå¤‰æ›´ç‚¹:
1. **ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª**: `app.py` â†’ `unified_backend_api.py`
2. **ãƒ¡ã‚¤ãƒ³UI**: `templates/index.html` â†’ `templates/unified_chatbot.html`
3. **APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `/api/search-partners` â†’ `/api/partners/search`
4. **Notionã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: æ—¢å­˜ã®`data_access/notion_client.py`ã‚’ä½¿ç”¨
5. **URL**: æœ¬ç•ªURL (`https://web-production-c8b78.up.railway.app/`) ã‚’åæ˜ 

ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹é€ ã«åˆã‚ã›ã¦ä¿®æ­£æ¸ˆã¿ã§ã™ã€‚

