<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å ´å‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        h1 {
            color: #333;
            font-size: 24px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .filters {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .cases-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .case-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            transition: box-shadow 0.3s;
        }
        
        .case-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .case-title {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        
        .case-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-å—ä»˜ { background: #3498db; color: white; }
        .status-è¨ºæ–­ä¸­ { background: #f39c12; color: white; }
        .status-ä¿®ç†ä¸­ { background: #9b59b6; color: white; }
        .status-å®Œäº† { background: #27ae60; color: white; }
        .status-ã‚­ãƒ£ãƒ³ã‚»ãƒ« { background: #e74c3c; color: white; }
        
        .case-info {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .case-message {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #667eea;
        }
        
        .case-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn-update {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-update:hover {
            background: #229954;
        }
        
        .comment-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .comment-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .btn-comment {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-comment:hover {
            background: #2980b9;
        }
        
        .existing-comments {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            font-size: 13px;
            color: #666;
            white-space: pre-wrap;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .case-header {
                flex-direction: column;
            }
            
            .case-actions {
                flex-direction: column;
            }
            
            .action-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ å·¥å ´å‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <a href="/admin/logout" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <span style="font-weight: bold; margin-right: 10px;">ãƒ•ã‚£ãƒ«ã‚¿:</span>
            <button class="filter-btn" onclick="filterCases('')">ã™ã¹ã¦</button>
            <button class="filter-btn" onclick="filterCases('å—ä»˜')">å—ä»˜</button>
            <button class="filter-btn" onclick="filterCases('è¨ºæ–­ä¸­')">è¨ºæ–­ä¸­</button>
            <button class="filter-btn" onclick="filterCases('ä¿®ç†ä¸­')">ä¿®ç†ä¸­</button>
            <button class="filter-btn" onclick="filterCases('å®Œäº†')">å®Œäº†</button>
            <button class="filter-btn" onclick="filterCases('ã‚­ãƒ£ãƒ³ã‚»ãƒ«')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>
    
    <div class="cases-container">
        <div id="loading" class="loading">
            <p>æ¡ˆä»¶ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        
        <div id="cases-list" style="display: none;"></div>
        
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
        </div>
    </div>
    
    <script>
        let currentFilter = '{{ status_filter }}';
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ¡ˆä»¶ã‚’å–å¾—
        window.addEventListener('DOMContentLoaded', function() {
            loadCases(currentFilter);
            updateFilterButtons(currentFilter);
        });
        
        function filterCases(status) {
            currentFilter = status;
            loadCases(status);
            updateFilterButtons(status);
        }
        
        function updateFilterButtons(activeStatus) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === (activeStatus || 'ã™ã¹ã¦')) {
                    btn.classList.add('active');
                }
            });
        }
        
        async function loadCases(status = '') {
            const loadingEl = document.getElementById('loading');
            const casesListEl = document.getElementById('cases-list');
            const emptyStateEl = document.getElementById('empty-state');
            
            loadingEl.style.display = 'block';
            casesListEl.style.display = 'none';
            emptyStateEl.style.display = 'none';
            
            try {
                const url = `/admin/api/cases${status ? '?status=' + encodeURIComponent(status) : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                loadingEl.style.display = 'none';
                
                if (data.success && data.cases.length > 0) {
                    casesListEl.style.display = 'block';
                    renderCases(data.cases);
                } else {
                    emptyStateEl.style.display = 'block';
                }
            } catch (error) {
                console.error('æ¡ˆä»¶å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                loadingEl.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }
        
        function renderCases(cases) {
            const casesListEl = document.getElementById('cases-list');
            casesListEl.innerHTML = cases.map(case => `
                <div class="case-card" data-page-id="${case.page_id}">
                    <div class="case-header">
                        <div class="case-title">${escapeHtml(case.title)}</div>
                        <span class="case-status status-${case.status || 'å—ä»˜'}">${case.status || 'å—ä»˜'}</span>
                    </div>
                    
                    <div class="case-info">
                        <div>ğŸ“… ${formatDate(case.timestamp || case.created_time)}</div>
                        ${case.category ? `<div>ğŸ·ï¸ ${escapeHtml(case.category)}</div>` : ''}
                        ${case.session_id ? `<div>ğŸ†” ${escapeHtml(case.session_id.substring(0, 8))}...</div>` : ''}
                    </div>
                    
                    ${case.user_message ? `
                        <div class="case-message">
                            <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> ${escapeHtml(case.user_message.substring(0, 200))}${case.user_message.length > 200 ? '...' : ''}
                        </div>
                    ` : ''}
                    
                    ${case.bot_message ? `
                        <div class="case-message">
                            <strong>AIå¿œç­”:</strong> ${escapeHtml(case.bot_message.substring(0, 200))}${case.bot_message.length > 200 ? '...' : ''}
                        </div>
                    ` : ''}
                    
                    <div class="case-actions">
                        <select class="action-select" id="status-${case.page_id}">
                            <option value="å—ä»˜" ${case.status === 'å—ä»˜' ? 'selected' : ''}>å—ä»˜</option>
                            <option value="è¨ºæ–­ä¸­" ${case.status === 'è¨ºæ–­ä¸­' ? 'selected' : ''}>è¨ºæ–­ä¸­</option>
                            <option value="ä¿®ç†ä¸­" ${case.status === 'ä¿®ç†ä¸­' ? 'selected' : ''}>ä¿®ç†ä¸­</option>
                            <option value="å®Œäº†" ${case.status === 'å®Œäº†' ? 'selected' : ''}>å®Œäº†</option>
                            <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«" ${case.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' ? 'selected' : ''}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        </select>
                        <button class="btn-update" onclick="updateStatus('${case.page_id}')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</button>
                    </div>
                    
                    <div class="comment-section">
                        <input type="text" class="comment-input" id="comment-${case.page_id}" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">
                        <button class="btn-comment" onclick="addComment('${case.page_id}')">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </button>
                        ${case.comment ? `<div class="existing-comments">${escapeHtml(case.comment)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function updateStatus(pageId) {
            const statusSelect = document.getElementById(`status-${pageId}`);
            const newStatus = statusSelect.value;
            
            try {
                const response = await fetch('/admin/api/update-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page_id: pageId,
                        status: newStatus
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    loadCases(currentFilter); // å†èª­ã¿è¾¼ã¿
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        async function addComment(pageId) {
            const commentInput = document.getElementById(`comment-${pageId}`);
            const comment = commentInput.value.trim();
            
            if (!comment) {
                alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch('/admin/api/add-comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page_id: pageId,
                        comment: comment
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    commentInput.value = '';
                    loadCases(currentFilter); // å†èª­ã¿è¾¼ã¿
                } else {
                    alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + data.error);
                }
            } catch (error) {
                console.error('ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'æ—¥æ™‚ä¸æ˜';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('ja-JP');
            } catch {
                return dateString;
            }
        }
    </script>
</body>
</html>

