#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import os
import streamlit as st
from dotenv import load_dotenv

# .envãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
load_dotenv()

def check_notion_databases():
    """Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹é€ ã¨IDã‚’ç¢ºèª"""
    print("ğŸ” Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ç¢ºèªã‚’é–‹å§‹...")
    
    # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
    notion_api_key = os.getenv("NOTION_API_KEY") or os.getenv("NOTION_TOKEN")
    if not notion_api_key:
        print("âŒ Notion APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return
    
    try:
        from notion_client import Client
        client = Client(auth=notion_api_key)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        user = client.users.me()
        print(f"âœ… Notionæ¥ç¶šæˆåŠŸ: {user.get('name', 'Unknown User')}")
        
        # åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢
        print("\nğŸ“‹ åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:")
        try:
            response = client.search(
                filter={"property": "object", "value": "database"},
                sort={"direction": "descending", "timestamp": "last_edited_time"}
            )
            
            databases = response.get("results", [])
            print(f"âœ… {len(databases)}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ")
            
            for i, db in enumerate(databases[:10], 1):  # æœ€åˆã®10ä»¶ã‚’è¡¨ç¤º
                db_id = db.get("id", "")
                title = "ã‚¿ã‚¤ãƒˆãƒ«ãªã—"
                
                # ã‚¿ã‚¤ãƒˆãƒ«ã®æŠ½å‡º
                title_prop = db.get("title", [])
                if title_prop:
                    title = title_prop[0].get("plain_text", "ã‚¿ã‚¤ãƒˆãƒ«ãªã—")
                
                print(f"{i}. {title}")
                print(f"   ID: {db_id}")
                print(f"   URL: https://notion.so/workspace/{db_id}")
                print()
                
        except Exception as e:
            print(f"âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã«å¤±æ•—: {e}")
        
        # ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã§ãƒ†ã‚¹ãƒˆ
        test_db_ids = [
            "256709bb38f18069a903f7ade8f76c73",  # ç¾åœ¨ã®è¨ºæ–­ãƒ•ãƒ­ãƒ¼DB
            "256709bb38f180eb8013c02989449e6d",  # ç¾åœ¨ã®ä¿®ç†ã‚±ãƒ¼ã‚¹DB
            "256709bb38f18048a5d0c6524e03bae5"   # ç¾åœ¨ã®éƒ¨å“ãƒ»å·¥å…·DB
        ]
        
        print("ğŸ” è¨­å®šæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã®ãƒ†ã‚¹ãƒˆ:")
        for db_id in test_db_ids:
            try:
                response = client.databases.retrieve(database_id=db_id)
                title = "ã‚¿ã‚¤ãƒˆãƒ«ãªã—"
                title_prop = response.get("title", [])
                if title_prop:
                    title = title_prop[0].get("plain_text", "ã‚¿ã‚¤ãƒˆãƒ«ãªã—")
                print(f"âœ… {db_id}: {title}")
            except Exception as e:
                print(f"âŒ {db_id}: ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ - {e}")
        
    except ImportError as e:
        print(f"âŒ notion-clientãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“: {e}")
        print("ğŸ’¡ è§£æ±ºæ–¹æ³•: pip install notion-client==2.2.1")
    except Exception as e:
        print(f"âŒ Notionæ¥ç¶šã‚¨ãƒ©ãƒ¼: {e}")

if __name__ == "__main__":
    check_notion_databases()